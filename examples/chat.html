<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ws-nats chat</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          crossorigin="anonymous">
</head>
<body onunload="exiting()">
<div class="container">
    <h1>ws-nats chat</h1>
    <input type="text" class="form-control" id="data" placeholder="Message" autocomplete="off"><br/>
    <button id="send" onclick="send()" class="btn btn-primary">Send</button>
</div>
<br/>
<div id="chats" class="container">

</div>

<script src="../lib/nats.js"></script>

<script>
    let me = Date.now();

    async function doit() {
        let nc = await nats.connect({url: "ws://localhost:8080", payload: "json"});
        nc.subscribe("chat", (msg) => {
            let p = document.createElement("pre");
            let message = msg.data.id === me ? `(me): ${msg.data.m}` : `(${msg.data.id}): ${msg.data.m}`;
            p.appendChild(document.createTextNode(message));
            document.getElementById('chats').appendChild(p);
        });

        nc.subscribe("enter", (msg) => {
            let p = document.createElement("pre");
            if (msg.data.id !== me) {
                p.appendChild(document.createTextNode(`${msg.data.id} entered.`));
                document.getElementById('chats').appendChild(p);
            }
        });

        nc.subscribe("exit", (msg) => {
            let p = document.createElement("pre");
            if (msg.data.id !== me) {
                p.appendChild(document.createTextNode(`${msg.data.id} exited.`));
                document.getElementById('chats').appendChild(p);
            }
        });

        nc.publish('enter', {id: me});

        window.nc = nc;
    }

    doit();


    let input = document.getElementById('data');
    input.addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
            document.getElementById("send").click();
        } else {
            e.preventDefault();
        }
    });

    function send() {
        input = document.getElementById('data');
        let m = input.value;
        if (m !== "") {
            window.nc.publish('chat', {id: me, m: m});
            input.value = "";
        }
        return false;
    }

    function exiting() {
        window.nc.publish('exit', {id: me});
    }

</script>
</body>
</html>




